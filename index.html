<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.3/ace.min.css" integrity="sha512-X5R0o7s/YdM5c2gZ8eG6yK27w1/0/g8L1qj5p/8/9O8Y2L7fF6G1K+lP8dIq7N2c/Fq/sI7l4w6x0N3Oq0w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f4f4f4;
        margin: 20px;
        text-align: center;
      }
      #upload-form {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
      }
      
      #upload-form input[type="file"] {
        display: none;
      }
      .custom-file-upload {
        border: 1px solid #ccc;
        display: inline-block;
        padding: 10px 12px;
        cursor: pointer;
        background-color: #fff;
        margin-bottom: 10px;
      }
      .custom-file-upload:hover {
          background-color: #e8e8e8;
      }
      .custom-file-upload i {
        margin-right: 5px;
      }

      #upload-form button {
        padding: 10px 12px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        margin: 5px;
      }
      #upload-form button:hover {
        background-color: #367c38;
      }

      #link-area {
          margin-top: 10px;
          text-align: left;
          padding: 10px;
      }

      #editor {
        width: 80%;
        height: 400px;
        margin: 20px auto;
      }
    </style>
</head>
<body>
    <h1>Gerador de CDN</h1>
        <div id="upload-form">
        <input type="file" id="file-upload">
        <label for="file-upload" class="custom-file-upload">
          <i class="fas fa-upload"></i> Selecione o arquivo
        </label>
        <button id="generate-cdn">Converter para CDN</button>
        <button id="generate-base64-cdn">Converter para CDN base64</button>
    </div>
        <div id="link-area" >
        </div>
    <div id="editor"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.3/ace.min.js" integrity="sha512-cT1E2E6J1q87R2G+o7k/8y0v41s9o86V2/xK2Fm9r/Y2H3+3H6j+0I3/I8x+p7y8G0/7E2N5B5F0/9/v1p0Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const fileUpload = document.getElementById('file-upload');
        const generateCDNButton = document.getElementById('generate-cdn');
        const generateBase64CDNButton = document.getElementById('generate-base64-cdn');
        const linkArea = document.getElementById('link-area');
        const editorElement = document.getElementById('editor');
        let editor;

        const aceScript = document.querySelector('script[src*="ace.min.js"]');

        aceScript.onload = function () {
          editor = ace.edit(editorElement);
          editor.setTheme("ace/theme/monokai");
          editor.session.setMode("ace/mode/javascript");
        };

        generateCDNButton.addEventListener('click', () => handleGenerateCDN(false));
        generateBase64CDNButton.addEventListener('click', () => handleGenerateCDN(true));

        async function handleGenerateCDN(base64) {
            if (!fileUpload.files[0]) {
                alert("Selecione um arquivo!");
                return;
            }

            const file = fileUpload.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('base64', base64);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error('Falha ao gerar CDN');
                }

                const data = await response.json();
                console.log(data);
                const link = data.link;
                const url = window.location.origin + link;

                linkArea.innerHTML = `<p>CDN link: <a href="${url}" target="_blank">${url}</a></p>`;
                await showOnEditor(url, data.base64);

            } catch(error){
                console.error("Ocorreu um erro:", error)
            }
        }

        async function showOnEditor(url, isBase64) {
            try {
            const response = await fetch(url);
            const content = await response.text();

            if (isBase64) {
                let base64Text = content;
                editor.session.setValue(atob(base64Text));
                editor.session.setMode("ace/mode/text");
            } else {
                editor.session.setValue(content);
                const mode = getModeFromURL(url);
                editor.session.setMode(mode);
            }
            } catch (error) {
            console.error("Falha ao exibir no editor", error);
            }
        }

        function getModeFromURL(url) {
        const extension = url.split('.').pop().toLowerCase();

        switch (extension) {
            case 'js':
            return 'ace/mode/javascript';
            case 'css':
            return 'ace/mode/css';
            case 'html':
            return 'ace/mode/html';
            default:
            return 'ace/mode/text';
        }
        }
    </script>
</body>
</html>
